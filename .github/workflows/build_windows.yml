name: build DSI Studio

on:
  push:
    tags:
      - "*"

jobs:
  windows_build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v1
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          version: 5.12.0
          modules: qtcharts
        
      - name: Download and Install Boost
        uses: MarkusJx/install-boost@v2.0.0      
        with:
          boost_version: 1.76.0
          boost_install_dir: ${{ github.workspace }}
      - name: get TIPL and DSI Studio atlas
        run: |
          git clone https://github.com/frankyeh/TIPL.git
          git clone https://github.com/frankyeh/DSI-Studio-atlas.git
          move ${{ github.workspace }}/boost ${{ github.workspace }}/boost_
          move ${{ github.workspace }}/boost_/boost/include/boost* ${{ github.workspace }}/boost__
          move ${{ github.workspace }}/boost__/boost ${{ github.workspace }}/boost
          dir ${{ github.workspace }}/boost
          
      - name: Build DSI Studio
        run: |
          call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          mkdir -p build
          cd build
          qmake ../dsi_studio.pro 
          nmake
        shell: cmd

      - name: Packaging
        run: |
          mkdir dsi_studio_win
          move other\color_map dsi_studio_win   
          move other\device.txt dsi_studio_win   
          move build\release\dsi_studio.exe dsi_studio_win
          windeployqt dsi_studio_win\dsi_studio.exe
          move DSI-Studio-atlas dsi_studio_win\atlas  
      - name: Zip Release
        uses: TheDoctor0/zip-release@0.6.0
        with:
          filename: dsi_studio_win.zip
          directory: dsi_studio_win
      - name: Get tag
        id: tag
        uses: dawidd6/action-get-tag@v1
      - name: Create Release
        uses: ncipollo/release-action@v1.8.9
        with:
          allowUpdates: true
          artifacts: "*.zip"
          tag: ${{steps.tag.outputs.tag}}
          prerelease: false   
